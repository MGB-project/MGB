{% extends 'template.html' %}

{% load static %}
{% load movie_tags %}

{% block title %}
  Games Detail
{% endblock %}

{% block css %}
  <link rel="stylesheet" href="{% static 'css/movies/movie-detail/movie_detail.css' %}">
  <link rel="stylesheet" href="{% static 'css/mgb_tabs.css' %}">
  <link rel="stylesheet" href="{% static 'css/all-reviews.css' %}">
  <link rel="stylesheet" href="{% static 'css/friends-reviews.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
{% endblock %}



{% block content %}
  <div class="main-backdrop">
    {% if movie.custom_header_photo %}
      <img src="{{ movie.custom_header_photo }}">
    {% else %}
      <img src="{{ movie.full_backdrop_path }}">
    {% endif %}
  </div>

  <div class="movie-info-block">

    <div class="custom-movie-ratings">
      {% if movie.vote_average and movie.vote_average > 0 %}
          <span class="custom-movie-rating" style="background-color: {{ movie.rating_color|default:'gray' }};">
              {{ movie.vote_average|floatformat:1 }}
          </span>
      {% else %}
          <span class="custom-movie-rating" style="background-color: gray;">
              ?
          </span>
      {% endif %}
      <div class="movie-detail-genres">
        {% for genre in movie.genres.all|slice:":3" %}
          <span class="movie-genre">{{ genre }}</span>
        {% endfor %}
      </div>

      <div class="date-country-seasons-adult">
        {% if movie.release_date %}
          <span class="date-block">{{ movie.release_date|date:"Y" }}</span>
          <p>•</p>
        {% endif %}
        
        {% if movie.country %}
          <span class="country-block">{{ movie.country }}</span>
        {% endif %}
       
        {% if movie.runtime %}
          <p>•</p>
          <span class="seasons-block">{{ movie.formatted_runtime }}</span>
        {% endif %}

        {% if movie.adult == True %}
          <p>•</p>
          <span class="adult-block">18+</span>
        {% endif %}

      </div>
    </div>

    <div class="title-btns">
      <h1 class="movie-title">{{ movie.title }}</h1>
      <div class="main-btns">
        {% movie_actions movie=movie size='large' show_learn_more=False show_rating=True %}
      </div>
    </div>
    <div class="line-object">
      <hr>
    </div>

    <div class="games-tabs">
      <button class="active" onclick="showTab('addit-info')">Overview</button>
      <button onclick="showTab('sim-games')">Similar Movies</button>
      <button onclick="showTab('all-rev')" id="btn-all-rev">Reviews</button>
      <button onclick="showTab('friends-rev')">Friends</button>
      
    </div>


    <!-- OVERVIEW -->
    <div id="addit-info" class="tab-content active">
      <div class="overview-container">

        <div class="overview-left">
          <div class="poster-video">
            <img src="{{ movie.full_poster_path }}" alt="">
            <!-- <iframe src="https://www.youtube.com/embed/{{ game.youtube_trailer }}?autoplay=1&mute=1" 
                    frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
            </iframe> -->
          </div>
          <div class="movie-description">
            <div class="storyline-block">
              <div class="storyline">
                <hr class="movie-line">
                <h2>Storyline</h2>
              </div>
              <p>{{ movie.overview }}</p>
            </div>

            <div class="info-block">
              <div class="details">
                <hr class="movie-line">
                <h2>Details</h2>
              </div>
              <div class="detail-info">
                <div class="detail-values">
                  {% if genres %}
                    <div class="detail-genres">
                      <h3>Жанры:</h3>
                      <div class="genres">
                        {% for genre in movie.genres.all %}
                          <span>{{ genre }}</span>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  {% for director in movie.crew.all|dictsort:"name" %}
                    {% if director.job == "Director" %}
                      <div class="detail-director">
                        <h3>Директор:</h3>
                        <div class="director">
                          <span>{{ director.name }}</span>{% if not forloop.last %}, {% endif %}
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                  
                  {% for screenwriter in movie.crew.all|dictsort:"name" %}
                    {% if screenwriter.job == "Screenwriter" %}
                      <div class="detail-screenwriter">
                        <h3>Сценарий:</h3>
                        <div class="screenwriter">
                          <span>{{ screenwriter.name }}</span>{% if not forloop.last %}, {% endif %}
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}


                  {% for producer in movie.crew.all|dictsort:"name" %}
                    {% if producer.job == "Producer" %}
                      <div class="detail-producer">
                        <h3>Продюссеры:</h3>
                        <div class="producer">
                          <span>{{ producer.name }}</span>{% if not forloop.last %}, {% endif %}
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}

                  {% if actors %}
                    <div class="detail-actors">
                      <h3>Актеры:</h3>
                      <div class="actors">
                        {% for actor in movie.actors.all %}
                          <span>{{ actor }}</span>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  {% if movie.release_date %}
                    <div class="detail-date">
                      <h3>Дата релиза:</h3>
                      <span>{{ movie.release_date }}</span>
                    </div>
                  {% endif %}

                  {% if movie.country %}
                    <div class="detail-country">
                      <h3>Страна:</h3>
                      <span>{{ movie.country }}</span>
                    </div>
                  {% endif %}

                  {% if movie.runtime %}
                    <div class="detail-time">
                      <h3>Время серии:</h3>
                      <span>{{ movie.formatted_runtime }}</span>
                    </div>
                  {% endif %}

                  {% if movie.content_type == 'tv' %}
                    {% if movie.number_of_seasons %}
                      <div class="seasons">
                        <h3>Количество сезонов</h3>
                        <span>{{ movie.number_of_seasons }}</span>
                      </div>
                    {% endif %}

                    {% if movie.number_of_episodes %}
                      <div class="episodes">
                        <h3>Количество серий</h3>
                        <span>{{ movie.number_of_episodes }}</span>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="overview-right">
          <div class="statistics">
            <hr class="movie-line">
            <h2>Statistics</h2>
          </div>
          <div class="statistics-block">
            <div class="statistic-values">
              <div class="statistic-rates">
                <h3>Rates:</h3>
                <span>{{ movie.vote_count }}</span>
              </div>
              <div class="statistic-watched">
                <h3>Watched:</h3>
                <div class="watched">
                  <img src="{% static 'imgs/icons/watch.svg' %}">
                  <span>{{ movie.watched_by.count }}</span>
                </div>
              </div>
              <div class="statistic-watching">
                <h3>Watching:</h3>
                <span>{{ movie.watching_by.count }}</span>
              </div>
              <div class="statistic-dropped">
                <h3>Dropped:</h3>
                <span>{{ movie.dropped_by.count }}</span>
              </div>
              <div class="statistic-reviews">
                <h3>Reviews:</h3>
                <span>{{ comment_count }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- SIMILAR GAMES -->
    <div id="sim-games" class="tab-content">
      {% if similar_movies %}
      <div class="swiper-container">
        <div class="swiper sim-movies-swiper">
          <div class="swiper-button-prev"></div>
          <div class="swiper-button-next"></div>
          <div class="swiper-wrapper">
            {% for movie in similar_movies %}
              <div class="swiper-slide">
                <a href="{% url 'movie_detail' movie.id %}" class="movie-link">
                  {% if movie.custom_header_photo %}
                    <div class="small-movie-bg" style="background: url({{ movie.custom_header_photo }});">
                  {% else %}
                    <div class="small-movie-bg" style="background: url({{ movie.full_poster_path }});">
                  {% endif %} 
                  {% if movie.vote_average and movie.vote_average > 0 %}
                      <span class="movie-rating" style="background-color: {{ movie.rating_color|default:'gray' }};">
                          {{ movie.vote_average|floatformat:1 }}
                      </span>
                  {% else %}
                      <span class="movie-rating" style="background-color: gray;">
                          ?
                      </span>
                  {% endif %}
                </div>
                <h2>{{ movie.original_title }}</h2>
              </a>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% else %}
        <p>нет похожих</p>
      {% endif %}
    </div>

    <!-- REVIEWS -->
    <div id="all-rev" class="tab-content">
      <div class="comments-section">
        
        <form id="comment-form">
          {% csrf_token %}
          {% if profile.avatar %}
            <img src="{{ profile.avatar.url }}" class="profile-logo-header" alt="">
          {% else %}
            <img src="{% static 'imgs/icons/profile_btn.svg' %}" alt="profile default">
          {% endif %}
          <div class="add-comment-user">
            <input type="hidden" id="comment-type" value="movie">
            <input type="hidden" id="object-id" value="{{ movie.id }}">
        
            <div class="input-container">
              <input class="field__input" type="text" id="comment-title" required>
              <label class="field__label" for="comment-title">Title</label>
            </div>

            <textarea id="comment-text" placeholder="Text" required></textarea>
        
            <div class="btns-comment">
              <button class="cancel-comment" type="button">Cancel</button>
              <button class="publish-comment" type="submit">Publish</button>
            </div>
          </div>
        </form>
    
        <h1>{{ comment_count }} Users reviews</h1>

        <div id="commentsList">
          {% for comment in movie.comments.all %}
            <div class="comment" id="comment-{{ comment.id }}">
              <img src="{{ comment.user.avatar.url }}" alt="avatar">
              <div class="comment-content">
                <div class="comment-info">
                  <div class="comment-meta">
                    <div class="username-date">
                      <h2>{{ comment.user.username }}</h2>
                      <span class="comment-date">{{ comment.created_at }}</span>
                    </div>
                    <h3>{{ comment.title }}</h3>
                  </div>
                  <span class="user-rating">
                    <img src="{% static 'imgs/icons/btn-star-small.svg' %}" alt="Star btn">
                    10
                  </span>
                </div>
                <span class="comment-text">{{ comment.content }}</span>
                <div class="reactions-to-comment">
                  <div class="likes">
                    <button class="like-btn" data-id="{{ comment.id }}">
                      <img src="{% if user in comment.likes.all %}{% static 'imgs/icons/red_like_comment.svg' %}{% else %}{% static 'imgs/icons/like_comment.svg' %}{% endif %}" alt="Like Button">
                    </button>
                    <span class="like-count">{{ comment.likes.count }}</span> <!-- Элемент для количества лайков -->
                  </div>
                  <button class="reply-comment">
                    <img src="{% static 'imgs/icons/reply.svg' %}" alt="Reply btn">
                    Reply
                  </button>
                </div>
                <button class="show-replies">0 replies</button>
                <div class="reply-form" style="display: none;">
                  <input type="text" class="reply-title" placeholder="Title" required>
                  <textarea class="reply-text" placeholder="Text" required></textarea>
                  <button class="publish-reply">Publish</button>
                </div>
              </div>
            </div>
          {% empty %}
            <p>Комментариев пока нет. Будьте первым!</p>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- FREIND REVIEW -->
    <div id="friends-rev" class="tab-content">
      <h2>Challenges</h2>
      <p>Контент вкладки Challenges</p>
    </div>

  </div>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="{% static 'scripts/movies/movie_detail.js' %}"></script>
  <script src="{% static 'scripts/mgb_tabs.js' %}"></script>
  <script src="{% static 'scripts/item_actions.js' %}"></script>
  

{% endblock %}